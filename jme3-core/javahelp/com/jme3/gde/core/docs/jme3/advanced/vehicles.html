


<h1><a name="controlling_a_physical_vehicle" id="controlling_a_physical_vehicle">Controlling a Physical Vehicle</a></h1>
<div class="level1">

<p>

jME&#039;s uses the jBullet ray-cast vehicle, a vehicle implementation where the chassis &#039;floats&#039; along on four vertical rays. Internally, each wheel casts a ray down, and using the ray&#039;s intersection point, jBullet calculates the suspension length, and the suspension force. The suspension force is applied to the chassis, keeping it from hitting the ground. The friction force is calculated for each wheel where the ray intersects with the ground. Friction is applied as a sideways and forwards force. <sup><a href="#fn__1" name="fnt__1" id="fnt__1" class="fn_top">1)</a></sup>
</p>

<p>
Here is how you use this vehicle implementation in a jME application.
</p>

<p>
<img src="nbdocs:/com/jme3/gde/core/docs/jme3/advanced/physics-vehicle.png">
</p>

</div>
<!-- SECTION "Controlling a Physical Vehicle" [1-746] -->
<h2><a name="sample_code" id="sample_code">Sample Code</a></h2>
<div class="level2">

<p>

Full code samples are here:

</p>
<ul>
<li class="level1"><div class="li"> <object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://code.google.com/p/jmonkeyengine/source/browse/branches/jme3/src/test/jme3test/bullet/TestPhysicsCar.java"><param name="text" value="<html><u>TestPhysicsCar.java</u></html>"><param name="textColor" value="blue"></object></div>
</li>
<li class="level1"><div class="li"> <object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://code.google.com/p/jmonkeyengine/source/browse/branches/jme3/src/test/jme3test/bullet/TestFancyCar.java"><param name="text" value="<html><u>TestFancyCar.java</u></html>"><param name="textColor" value="blue"></object></div>
</li>
</ul>

</div>
<!-- SECTION "Sample Code" [747-1077] -->
<h2><a name="overview_of_this_physics_application" id="overview_of_this_physics_application">Overview of this Physics Application</a></h2>
<div class="level2">

<p>

The goal is to create a physical vehicle with wheels that can be steered and that interacts (collides with) with the floor and obstacles.

</p>
<ol>
<li class="level1"><div class="li"> Create a SimpleApplication with a <a href="/com/jme3/gde/core/docs/jme3/advanced/physics.html" class="wikilink1" title="jme3:advanced:physics">BulletAppState</a> </div>
<ul>
<li class="level2"><div class="li"> This gives us a PhysicsSpace for PhysicsNodes</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Create a PhysicsVehicleNode + CompoundCollisionShape for the vehicle</div>
<ol>
<li class="level2"><div class="li"> Create a box plus 4 cylinders as wheels (using <code>vehicle.addWheel()</code>).</div>
</li>
<li class="level2"><div class="li"> Set physical properties of the vehicle, such as suspension.</div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Create a PhysicsNode + MeshCollisionShape for the floor</div>
</li>
<li class="level1"><div class="li"> Map key triggers and add input listeners</div>
<ul>
<li class="level2"><div class="li"> The usual Left, Right, Foward, Brake.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Define the steering actions to be triggered by the key events.</div>
<ul>
<li class="level2"><div class="li"> <code>vehicle.steer()</code></div>
</li>
<li class="level2"><div class="li"> <code>vehicle.accelerate()</code></div>
</li>
<li class="level2"><div class="li"> <code>vehicle.brake()</code></div>
</li>
</ul>
</li>
</ol>

</div>
<!-- SECTION "Overview of this Physics Application" [1078-1916] -->
<h2><a name="creating_the_vehicle_chassis" id="creating_the_vehicle_chassis">Creating the Vehicle Chassis</a></h2>
<div class="level2">

<p>

The vehicle we create in this example here is just a “box on wheels”, a basic vehicle shape that you can replace with a fancy car model.
</p>

<p>
Every physical object has a collision shape. For the vehicle, we use a compound collision shape that is made up of a box-shaped body; later we add four cylinder-shaped wheels. 
</p>

<p>
Note that we attach the BoxCollisionShape (vehicle body) to the CompoundCollisionShape at 0,1,0: This shifts the effective center of mass of the BoxCollisionShape to 0,-1,0 and makes the vehicle more stable. 
</p>
<pre class="code java">CompoundCollisionShape compoundShape <span class="sy0">=</span> <span class="kw1">new</span> CompoundCollisionShape<span class="br0">&#40;</span><span class="br0">&#41;</span>;
BoxCollisionShape box <span class="sy0">=</span> <span class="kw1">new</span> BoxCollisionShape<span class="br0">&#40;</span><span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>1.2f, 0.5f, 2.4f<span class="br0">&#41;</span><span class="br0">&#41;</span>;
compoundShape.<span class="me1">addChildShape</span><span class="br0">&#40;</span>box, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>0, <span class="nu0">1</span>, 0<span class="br0">&#41;</span><span class="br0">&#41;</span>;</pre>
<p>
We create the vehicle&#039;s physics node from the compound shape, and set its mass to a heavy value, such as 800f.
</p>
<pre class="code java">vehicle <span class="sy0">=</span> <span class="kw1">new</span> PhysicsVehicleNode<span class="br0">&#40;</span><span class="kw1">new</span> Node<span class="br0">&#40;</span><span class="br0">&#41;</span>, compoundShape, <span class="nu0">800</span><span class="br0">&#41;</span>;</pre>
<p>
We configure the physical properties of the vehicle&#039;s suspension: Compresion, Damping, Stiffness, and MaxSuspenionForce. Picking workable values for the wheel suspension can be tricky – for background info have a look at these <a href="https://docs.google.com/Doc?docid=0AXVUZ5xw6XpKZGNuZG56a3FfMzU0Z2NyZnF4Zmo&amp;hl=en" class="urlextern" title="https://docs.google.com/Doc?docid=0AXVUZ5xw6XpKZGNuZG56a3FfMzU0Z2NyZnF4Zmo&amp;hl=en"  rel="nofollow">Suspension Settings Tips</a>. For now, let&#039;s work with the following values:
</p>
<pre class="code java"><span class="kw4">float</span> stiffness <span class="sy0">=</span> 60.0f; <span class="co1">// 200 = F1 car</span>
<span class="kw4">float</span> compValue <span class="sy0">=</span> .3f;   <span class="co1">// (should be lower than damp)</span>
<span class="kw4">float</span> dampValue <span class="sy0">=</span> .4f;
vehicle.<span class="me1">setSuspensionCompression</span><span class="br0">&#40;</span>compValue <span class="sy0">*</span> 2.0f <span class="sy0">*</span> FastMath.<span class="me1">sqrt</span><span class="br0">&#40;</span>stiffness<span class="br0">&#41;</span><span class="br0">&#41;</span>;
vehicle.<span class="me1">setSuspensionDamping</span><span class="br0">&#40;</span>dampValue <span class="sy0">*</span> 2.0f <span class="sy0">*</span> FastMath.<span class="me1">sqrt</span><span class="br0">&#40;</span>stiffness<span class="br0">&#41;</span><span class="br0">&#41;</span>;
vehicle.<span class="me1">setSuspensionStiffness</span><span class="br0">&#40;</span>stiffness<span class="br0">&#41;</span>;
vehicle.<span class="me1">setMaxSuspensionForce</span><span class="br0">&#40;</span>10000.0f<span class="br0">&#41;</span>;</pre>
</div>
<!-- SECTION "Creating the Vehicle Chassis" [1917-3673] -->
<h2><a name="adding_the_wheels" id="adding_the_wheels">Adding the Wheels</a></h2>
<div class="level2">

<p>

We create four wheels and add them to the vehicle. Note that we are not creating the PhysicsVehicleWheel ourselves: Our wheel geometries are simple, non-physical discs (flat Cylinders), they are just visual decorations. The physical wheel behaviour (the PhysicsVehicleWheel object) is created by the <code>vehicle.addWheel()</code> method. 
</p>

<p>
The <code>addWheel()</code> method sets following properties:
</p>
<ul>
<li class="level1"><div class="li"> Spatial spat – Your wheel geometry.</div>
</li>
<li class="level1"><div class="li"> Vector3f connectionPoint – Coordinate where the suspension connects to the chassis.</div>
</li>
<li class="level1"><div class="li"> Vector3f direction – Wheel direction is typically a (0,-1,0) vector.</div>
</li>
<li class="level1"><div class="li"> Vector3f axle – Axle direction is typically a (-1,0,0) vector.</div>
</li>
<li class="level1"><div class="li"> float suspensionRestLength – Suspension rest length in world units</div>
</li>
<li class="level1"><div class="li"> float wheelRadius – Wheel radius in world units</div>
</li>
<li class="level1"><div class="li"> boolean isFrontWheel – Whether this wheel is one of the steering wheels. <br/>
 Front wheels turn visible when the vehicle turns.</div>
</li>
</ul>

<p>

We initialize a few variables that we will reuse when we add the four wheels. yOff, etc, are the particular wheel offsets for our small vehicle model.
</p>
<pre class="code java">Vector3f wheelDirection <span class="sy0">=</span> <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>0, <span class="sy0">-</span><span class="nu0">1</span>, 0<span class="br0">&#41;</span>; 
Vector3f wheelAxle <span class="sy0">=</span> <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span>, 0, 0<span class="br0">&#41;</span>; 
<span class="kw4">float</span> radius <span class="sy0">=</span> 0.5f;
<span class="kw4">float</span> restLength <span class="sy0">=</span> 0.3f;
<span class="kw4">float</span> yOff <span class="sy0">=</span> 0.5f;
<span class="kw4">float</span> xOff <span class="sy0">=</span> 1f;
<span class="kw4">float</span> zOff <span class="sy0">=</span> 2f;</pre>
<p>
For each wheel, we create a node and attach a Cylinder geometry to it. We rotate the wheel by 90° around the Y axis and add the wheel (plus its properties) to the vehicle.
</p>
<pre class="code java">Cylinder wheelMesh <span class="sy0">=</span> <span class="kw1">new</span> Cylinder<span class="br0">&#40;</span><span class="nu0">16</span>, <span class="nu0">16</span>, radius, radius <span class="sy0">*</span> 0.6f, <span class="kw2">true</span><span class="br0">&#41;</span>;
Geometry wheels1 <span class="sy0">=</span> <span class="kw1">new</span> Geometry<span class="br0">&#40;</span><span class="st0">&quot;wheel 1&quot;</span>, wheelMesh<span class="br0">&#41;</span>;
&nbsp;
Node node1 <span class="sy0">=</span> <span class="kw1">new</span> Node<span class="br0">&#40;</span><span class="st0">&quot;wheel 1 node&quot;</span><span class="br0">&#41;</span>;
node1.<span class="me1">attachChild</span><span class="br0">&#40;</span>wheels1<span class="br0">&#41;</span>;
wheels1.<span class="me1">rotate</span><span class="br0">&#40;</span>0, FastMath.<span class="me1">HALF_PI</span>, 0<span class="br0">&#41;</span>; <span class="co1">// 90° around Y axis</span>
wheels1.<span class="me1">setMaterial</span><span class="br0">&#40;</span>mat<span class="br0">&#41;</span>;
&nbsp;
vehicle.<span class="me1">addWheel</span><span class="br0">&#40;</span>wheels1, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>xOff, yOff, zOff<span class="br0">&#41;</span>,
                 wheelDirection, wheelAxle, restLength, radius, <span class="kw2">true</span><span class="br0">&#41;</span>;</pre>
<p>
The three next wheels are created in the same fashion, only the offsets are different. Remember to set the Boolean parameter to indicate whether it&#039;s a front wheel.
</p>
<pre class="code java">...
<span class="me1">vehicle</span>.<span class="me1">addWheel</span><span class="br0">&#40;</span>wheels2, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>xOff, yOff, zOff<span class="br0">&#41;</span>,
                wheelDirection, wheelAxle, restLength, radius, <span class="kw2">true</span><span class="br0">&#41;</span>;
...
<span class="me1">vehicle</span>.<span class="me1">addWheel</span><span class="br0">&#40;</span>wheels3, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span><span class="sy0">-</span>xOff, yOff, <span class="sy0">-</span>zOff<span class="br0">&#41;</span>,
                wheelDirection, wheelAxle, restLength, radius, <span class="kw2">false</span><span class="br0">&#41;</span>;
...
<span class="me1">vehicle</span>.<span class="me1">addWheel</span><span class="br0">&#40;</span>wheels4, <span class="kw1">new</span> Vector3f<span class="br0">&#40;</span>xOff, yOff, <span class="sy0">-</span>zOff<span class="br0">&#41;</span>,
                wheelDirection, wheelAxle, restLength, radius, <span class="kw2">false</span><span class="br0">&#41;</span>;</pre>
<p>
As usual, attach the vehicle to the rootNode to make it visible, and add it to the PhysicsSpace to make it physical.
</p>
<pre class="code java">rootNode.<span class="me1">attachChild</span><span class="br0">&#40;</span>vehicle<span class="br0">&#41;</span>;
getPhysicsSpace<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">add</span><span class="br0">&#40;</span>vehicle<span class="br0">&#41;</span>;</pre>
<p>
Not shown here is that we also created a Material <code>mat</code>.
</p>

</div>
<!-- SECTION "Adding the Wheels" [3674-6447] -->
<h2><a name="steering_the_vehicle" id="steering_the_vehicle">Steering the Vehicle</a></h2>
<div class="level2">

<p>

Not shown here is how we map the keys (see full code sample).
</p>

<p>
In the ActionListener, we implement the actions that control the vehicles direction and speed. For the four directions (accelerate=up, brake=down, left, right), we specify how we want the vehicle to move. 

</p>
<ul>
<li class="level1"><div class="li"> Braking action is pretty straightforward: <br/>
 <code>vehicle.brake(brakeForce)</code></div>
</li>
<li class="level1"><div class="li"> For left and right turns, we add a constant value to <code>steeringValue</code> when the key is pressed, and subtract it when the key is released. <br/>
 <code>vehicle.steer(steeringValue);</code></div>
</li>
<li class="level1"><div class="li"> For acceleration we add a constant to <code>accelerationValue</code> when the key is pressed, and substract it when the key is released. <br/>
 <code>vehicle.accelerate(accelerationValue);</code></div>
</li>
<li class="level1"><div class="li"> Because we can and it&#039;s fun, we also add a turbo booster that makes the vehicle jump up when you press the assigned key (spacebar). <br/>
 <code>vehicle.applyImpulse(jumpForce, Vector3f.ZERO);</code></div>
</li>
</ul>
<pre class="code java"><span class="kw1">public</span> <span class="kw4">void</span> onAction<span class="br0">&#40;</span><object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://www.google.com/search?hl=en&amp;q=allinurl%3Astring+java.sun.com&amp;btnI=I%27m%20Feeling%20Lucky"><param name="text" value="<html><u></u></html>"><param name="textColor" value="blue"></object> binding, <span class="kw4">boolean</span> isPressed, <span class="kw4">float</span> tpf<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>binding.<span class="me1">equals</span><span class="br0">&#40;</span><span class="st0">&quot;Left&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isPressed<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                steeringValue <span class="sy0">+=</span> .5f;
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                steeringValue <span class="sy0">+=</span> <span class="sy0">-</span>.5f;
            <span class="br0">&#125;</span>
            vehicle.<span class="me1">steer</span><span class="br0">&#40;</span>steeringValue<span class="br0">&#41;</span>;
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>binding.<span class="me1">equals</span><span class="br0">&#40;</span><span class="st0">&quot;Right&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isPressed<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                steeringValue <span class="sy0">+=</span> <span class="sy0">-</span>.5f;
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                steeringValue <span class="sy0">+=</span> .5f;
            <span class="br0">&#125;</span>
            vehicle.<span class="me1">steer</span><span class="br0">&#40;</span>steeringValue<span class="br0">&#41;</span>;
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>binding.<span class="me1">equals</span><span class="br0">&#40;</span><span class="st0">&quot;Forwards&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isPressed<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                accelerationValue <span class="sy0">+=</span> accelerationForce;
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                accelerationValue <span class="sy0">-=</span> accelerationForce;
            <span class="br0">&#125;</span>
            vehicle.<span class="me1">accelerate</span><span class="br0">&#40;</span>accelerationValue<span class="br0">&#41;</span>;
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>binding.<span class="me1">equals</span><span class="br0">&#40;</span><span class="st0">&quot;Brake&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isPressed<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                vehicle.<span class="me1">brake</span><span class="br0">&#40;</span>brakeForce<span class="br0">&#41;</span>;
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                vehicle.<span class="me1">brake</span><span class="br0">&#40;</span>0f<span class="br0">&#41;</span>;
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>binding.<span class="me1">equals</span><span class="br0">&#40;</span><span class="st0">&quot;Turbo Booster&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isPressed<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                vehicle.<span class="me1">applyImpulse</span><span class="br0">&#40;</span>jumpForce, Vector3f.<span class="me1">ZERO</span><span class="br0">&#41;</span>;
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre>
<p>
This is how we initialized the constants for this example:
</p>
<pre class="code java">accelerationForce <span class="sy0">=</span> 1000.0f;
brakeForce        <span class="sy0">=</span> 100.0f;
steeringValue     <span class="sy0">=</span> 0;
accelerationValue <span class="sy0">=</span> 0;</pre>
<p>
The input listener code that maps the actions to keys can be found in the code samples.
</p>

</div>
<!-- SECTION "Steering the Vehicle" [6448-8831] -->
<h2><a name="detecting_collisions" id="detecting_collisions">Detecting Collisions</a></h2>
<div class="level2">

<p>

Read the <a href="/com/jme3/gde/core/docs/jme3/advanced/physics#responding_to_a_physicscollisionevent.html" class="wikilink1" title="jme3:advanced:physics">Responding to a PhysicsCollisionEvent</a> chapter in the general physics documentation on how to detect collisions.
</p>

</div>
<!-- SECTION "Detecting Collisions" [8832-9052] -->
<h2><a name="best_practices" id="best_practices">Best Practices</a></h2>
<div class="level2">

<p>

This example shows a very simple but functional vehicle. For a game you would implement steering behaviour and acceleration with values that are typical for the type of vehicle that you want to simulate. Instead of a box, you load a chassis model. If the vehicle is more complex than a box, use a CompoundCollisionShape.  Consider using an <a href="/com/jme3/gde/core/docs/jme3/advanced/input_handling.html" class="wikilink1" title="jme3:advanced:input_handling">AnalogListener</a> to respond to key events in a more sophisticated way.
</p>

<p>
For a more advanced example, look at <object classid="java:org.netbeans.modules.javahelp.BrowserDisplayer"><param name="content" value="http://code.google.com/p/jmonkeyengine/source/browse/branches/jme3/src/test/jme3test/bullet/TestFancyCar.java"><param name="text" value="<html><u>TestFancyCar.java</u></html>"><param name="textColor" value="blue"></object>.
</p>

</div>
<!-- SECTION "Best Practices" [9053-] --><div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" id="fn__1" name="fn__1" class="fn_bot">1)</a></sup> 
 <a href="https://docs.google.com/Doc?docid=0AXVUZ5xw6XpKZGNuZG56a3FfMzU0Z2NyZnF4Zmo&amp;hl=en" class="urlextern" title="https://docs.google.com/Doc?docid=0AXVUZ5xw6XpKZGNuZG56a3FfMzU0Z2NyZnF4Zmo&amp;hl=en"  rel="nofollow">https://docs.google.com/Doc?docid=0AXVUZ5xw6XpKZGNuZG56a3FfMzU0Z2NyZnF4Zmo&amp;hl=en</a> </div>
</div>
<p><em><a href="http://jmonkeyengine.org/wiki/doku.php/jme3:advanced:vehicles?do=export_xhtmlbody">view online version</a></em></p>